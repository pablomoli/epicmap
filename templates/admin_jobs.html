<!doctype html>
<html>
  <head>
    <title>Admin - Jobs</title>
    <link rel="stylesheet" href="/static/css/style.css" />
    <script>
      function toggleFieldwork(jobNumber) {
        const row = document.getElementById("fw-" + jobNumber);
        row.style.display = row.style.display === "none" ? "table-row" : "none";
      }

      function changePerPage(perPage) {
        // Get current URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        
        // Update the per_page parameter
        urlParams.set('per_page', perPage);
        
        // Reset to page 1 when changing page size
        urlParams.set('page', 1);
        
        // Redirect to new URL
        window.location.href = window.location.pathname + '?' + urlParams.toString();
      }
    </script>
    <style>
      .modal {
        display: none;
        position: fixed;
        z-index: 10;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
      }

      .modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 2em;
        border: 1px solid #ccc;
        width: 400px;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
        font-family: sans-serif;
      }
      .modal-content button {
        background-color: #0066cc;
        color: white;
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        margin-top: 1em;
        cursor: pointer;
      }
      .modal-content button:hover {
        background-color: #004a99;
      }

      .close {
        color: #555;
        float: right;
        font-size: 24px;
        font-weight: bold;
        margin-top: -10px;
      }
      .close:hover {
        color: #000;
      }
      .modal {
        transition: opacity 0.3s ease;
      }

      .modal-content {
        opacity: 0;
        transform: scale(0.9);
        transition:
          opacity 0.3s ease,
          transform 0.3s ease;
      }
      .modal.show .modal-content {
        opacity: 1;
        transform: scale(1);
      }

      /* Additional styles for read-only table */
      .job-table tr:hover {
        background-color: #f5f5f5;
      }

      .action-btn {
        margin: 2px;
        padding: 5px 10px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
      }

      .edit-btn {
        background-color: #4caf50;
        color: white;
      }

      .delete-btn {
        background-color: #f44336;
        color: white;
      }

      .toggle-btn {
        background-color: #2196f3;
        color: white;
      }
      
      /* Pagination styles */
      .pagination {
        margin-top: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .pagination-list {
        display: flex;
        list-style-type: none;
        padding: 0;
        margin: 0 0 10px 0;
      }

      .pagination-list li {
        margin: 0 5px;
      }

      .pagination-list li a,
      .pagination-list li span {
        display: block;
        padding: 8px 12px;
        text-decoration: none;
        border-radius: 4px;
        color: #333;
        background-color: #f5f5f5;
        border: 1px solid #ddd;
      }

      .pagination-list li a:hover {
        background-color: #e0e0e0;
      }

      .pagination-list li.active span {
        background-color: #2196f3;
        color: white;
        border-color: #2196f3;
      }

      .pagination-list li.disabled span {
        color: #999;
        background-color: #f5f5f5;
        cursor: not-allowed;
      }

      .pagination-info {
        color: #666;
        font-size: 0.9em;
      }
      
      /* Per page selector */
      .per-page-selector {
        margin-top: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      .per-page-selector label {
        margin-right: 8px;
      }
      
      .per-page-selector select {
        padding: 4px 8px;
        border-radius: 4px;
        border: 1px solid #ddd;
      }
      
      .filter-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin-bottom: 10px;
      }
      
      .filter-row input, .filter-row select {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ddd;
      }
    </style>

    <script>
      function openModal(id) {
        const modal = document.getElementById(id);
        modal.style.display = "block";
        setTimeout(() => modal.classList.add("show"), 10);
      }

      function closeModal(id) {
        const modal = document.getElementById(id);
        modal.classList.remove("show");
        setTimeout(() => (modal.style.display = "none"), 300);
      }

      window.onclick = function (event) {
        const modals = document.querySelectorAll(".modal");
        modals.forEach((m) => {
          if (event.target === m) {
            m.style.display = "none";
          }
        });
      };
    </script>
  </head>
  <body>
    <h1>Job Admin Panel</h1>
    {% with messages = get_flashed_messages() %} 
      {% if messages %}
      <ul style="color: green; font-weight: bold">
        {% for msg in messages %}
        <li>{{ msg }}</li>
        {% endfor %}
      </ul>
      {% endif %} 
    {% endwith %}

    <form method="get">
      <input type="hidden" name="page" value="{{ request.args.get('page', 1) }}" />
      <input type="hidden" name="per_page" value="{{ request.args.get('per_page', 20) }}" />

      <div class="filter-row">
        <div>
          <label>Job #:</label>
          <input
            type="text"
            name="job_number"
            value="{{ request.args.get('job_number', '') }}"
          />
        </div>

        <div>
          <label>Client:</label>
          <input
            type="text"
            name="client"
            value="{{ request.args.get('client', '') }}"
          />
        </div>

        <div>
          <label>Status:</label>
          <select name="status">
            <option value="">-- All --</option>
            {% for status in status_options %}
              <option value="{{ status }}" {{ 'selected' if request.args.get('status') == status else '' }}>{{ status }}</option>
            {% endfor %}
          </select>
        </div>

        <div>
          <label>Address:</label>
          <input
            type="text"
            name="address"
            value="{{ request.args.get('address', '') }}"
          />
        </div>

        <div>
          <button type="submit">Apply Filters</button>
          <a href="/admin/jobs"><button type="button">Reset</button></a>
        </div>
      </div>
    </form>

    <div class="per-page-selector">
      <label for="per-page">Items per page:</label>
      <select id="per-page" onchange="changePerPage(this.value)">
        <option value="10" {% if pagination.per_page == 10 %}selected{% endif %}>10</option>
        <option value="20" {% if pagination.per_page == 20 %}selected{% endif %}>20</option>
        <option value="50" {% if pagination.per_page == 50 %}selected{% endif %}>50</option>
        <option value="100" {% if pagination.per_page == 100 %}selected{% endif %}>100</option>
      </select>
    </div>

    <table border="1" style="width: 100%; margin-top: 1em" class="job-table">
      <thead>
        <tr>
          <th>Job #</th>
          <th>Client</th>
          <th>Status</th>
          <th>Address</th>
          <th>County</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for job in jobs %}
        <tr>
          <td>{{ job.job_number }}</td>
          <td>{{ job.client }}</td>
          <td>{{ job.status }}</td>
          <td>{{ job.address }}</td>
          <td>{{ job.county }}</td>
          <td>
            <button
              type="button"
              class="action-btn edit-btn"
              onclick="openModal('edit-job-modal-{{ job.id }}')"
            >
              Edit
            </button>
            <form
              method="POST"
              action="/admin/delete_job/{{ job.id }}"
              style="display: inline"
            >
              <button
                type="submit"
                class="action-btn delete-btn"
                onclick="return confirm('Are you sure?')"
              >
                Delete
              </button>
            </form>
            <br />
            <button
              type="button"
              class="action-btn toggle-btn"
              onclick="toggleFieldwork('{{ job.job_number }}')"
            >
              Toggle Fieldwork
            </button>
          </td>
        </tr>

        <!-- Expandable fieldwork row -->
        <tr id="fw-{{ job.job_number }}" style="display: none">
          <td colspan="6">
            <!-- Button to add fieldwork - always visible -->
            <button
              class="action-btn edit-btn"
              onclick="openModal('fw-modal-{{ job.job_number }}')"
            >
              + Add Fieldwork
            </button>

            <!-- Fieldwork entries table -->
            {% set entries = fieldwork.get(job.job_id, []) %} 
            {% if entries %}
            <table border="1" width="100%" style="margin-top: 1em">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Start</th>
                  <th>End</th>
                  <th>Crew</th>
                  <th>Drone Card</th>
                  <th>Total Time</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for fw in entries %}
                <tr>
                  <form
                    method="POST"
                    action="/admin/update_fieldwork/{{ fw.id }}"
                  >
                    <td>
                      <input
                        type="date"
                        name="work_date"
                        value="{{ fw.work_date }}"
                      />
                    </td>
                    <td>
                      <input
                        type="time"
                        name="start_time"
                        value="{{ fw.start_time.strftime('%H:%M') }}"
                      />
                    </td>
                    <td>
                      <input
                        type="time"
                        name="end_time"
                        value="{{ fw.end_time.strftime('%H:%M') }}"
                      />
                    </td>
                    <td><input name="crew" value="{{ fw.crew or '' }}" /></td>
                    <td>
                      <input
                        name="drone_card"
                        value="{{ fw.drone_card or '' }}"
                      />
                    </td>
                    <td>{{ fw.total_time }}</td>
                    <td>
                      <button type="submit" class="action-btn edit-btn">
                        Update
                      </button>
                      <form
                        method="POST"
                        action="/admin/delete_fieldwork/{{ fw.id }}"
                        style="display: inline"
                      >
                        <button
                          type="submit"
                          class="action-btn delete-btn"
                          onclick="return confirm('Delete this entry?')"
                        >
                          Delete
                        </button>
                      </form>
                    </td>
                  </form>
                </tr>
                {% endfor %}
              </tbody>
            </table>
            {% else %}
            <p>No fieldwork entries yet.</p>
            {% endif %}

            <!-- Modal for adding fieldwork -->
            <div id="fw-modal-{{ job.job_number }}" class="modal">
              <div class="modal-content">
                <span
                  class="close"
                  onclick="closeModal('fw-modal-{{ job.job_number }}')"
                  >&times;</span
                >
                <h3>Add Fieldwork for Job {{ job.job_number }}</h3>
                <form
                  method="POST"
                  action="/admin/create_fieldwork/{{ job.id }}"
                >
                  <label>Date:</label><br />
                  <input type="date" name="work_date" required /><br />

                  <label>Start Time:</label><br />
                  <input type="time" name="start_time" required /><br />

                  <label>End Time:</label><br />
                  <input type="time" name="end_time" required /><br />

                  <label>Crew:</label><br />
                  <input type="text" name="crew" /><br />

                  <label>Drone Card:</label><br />
                  <input type="text" name="drone_card" /><br /><br />

                  <button type="submit">Add Fieldwork</button>
                </form>
              </div>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    
    <!-- Pagination - MOVED OUTSIDE THE TABLE -->
    <div class="pagination">
      <ul class="pagination-list">
        {% if pagination.has_prev %}
          <li>
            <a href="{{ url_for('admin.admin_jobs', page=pagination.prev_num, per_page=pagination.per_page, job_number=request.args.get('job_number', ''), client=request.args.get('client', ''), status=request.args.get('status', ''), address=request.args.get('address', '')) }}">&laquo; Previous</a>
          </li>
        {% else %}
          <li class="disabled"><span>&laquo; Previous</span></li>
        {% endif %}

        {% for page_num in pagination.iter_pages(left_edge=2, left_current=2, right_current=3, right_edge=2) %}
          {% if page_num %}
            {% if page_num == pagination.page %}
              <li class="active">
                <span>{{ page_num }}</span>
              </li>
            {% else %}
              <li>
                <a href="{{ url_for('admin.admin_jobs', page=page_num, per_page=pagination.per_page, job_number=request.args.get('job_number', ''), client=request.args.get('client', ''), status=request.args.get('status', ''), address=request.args.get('address', '')) }}">{{ page_num }}</a>
              </li>
            {% endif %}
          {% else %}
            <li class="disabled"><span>...</span></li>
          {% endif %}
        {% endfor %}

        {% if pagination.has_next %}
          <li>
            <a href="{{ url_for('admin.admin_jobs', page=pagination.next_num, per_page=pagination.per_page, job_number=request.args.get('job_number', ''), client=request.args.get('client', ''), status=request.args.get('status', ''), address=request.args.get('address', '')) }}">Next &raquo;</a>
          </li>
        {% else %}
          <li class="disabled"><span>Next &raquo;</span></li>
        {% endif %}
      </ul>
      
      <div class="pagination-info">
        Showing {{ pagination.items|length }} of {{ pagination.total }} jobs
        (Page {{ pagination.page }} of {{ pagination.pages }})
      </div>
    </div>

    <!-- Edit Job Modals -->
    {% for job in jobs %}
    <div id="edit-job-modal-{{ job.id }}" class="modal">
      <div class="modal-content">
        <span
          class="close"
          onclick="closeModal('edit-job-modal-{{ job.id }}')"
          >&times;</span
        >
        <h3>Edit Job #{{ job.job_number }}</h3>
        <form method="POST" action="/admin/update_job/{{ job.id }}">
          <label>Job #:</label><br />
          <input
            name="job_number"
            value="{{ job.job_number }}"
            readonly
          /><br />

          <label>Client:</label><br />
          <input name="client" value="{{ job.client }}" /><br />

          <label>Status:</label><br />
          <select name="status">
            <option value="" {{ 'selected' if not job.status else '' }}>-- Select Status --</option>
            {% for status in status_options %}
              <option value="{{ status }}" {{ 'selected' if job.status == status else '' }}>{{ status }}</option>
            {% endfor %}
          </select><br/>

          <label>Address:</label><br />
          <input name="address" value="{{ job.address }}" /><br />

          <label>County:</label><br />
          <input name="county" value="{{ job.county }}" /><br />

          <br />
          <button type="submit">Update Job</button>
        </form>
      </div>
    </div>
    {% endfor %}

    <!-- Modal Trigger Button -->
    <button
      onclick="openModal('createJobModal')"
      class="action-btn edit-btn"
      style="margin-top: 20px; font-size: 1.1em; padding: 8px 16px"
    >
      + Create New Job
    </button>

    <datalist id="clients">
      {% for job in jobs|unique(attribute='client') if job.client %}
      <option value="{{ job.client }}">{% endfor %}</option>
    </datalist>

    <datalist id="addresses">
      {% for job in jobs|unique(attribute='address') if job.address %}
      <option value="{{ job.address }}">{% endfor %}</option>
    </datalist>

    <!-- Modal for creating a new job -->
    <div id="createJobModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('createJobModal')"
          >&times;</span
        >
        <h2>Create New Job</h2>
        <form method="POST" action="/admin/create_job">
          <label>Job #:</label><br />
          <input type="text" name="job_number" required /><br />

          <label>Client:</label><br />
          <input type="text" name="client" list="clients" required /><br />

          <label>Status:</label><br />
          <select name="status">
            <option value="" selected>-- Select Status --</option>
            {% for status in status_options %}
              <option value="{{ status }}">{{ status }}</option>
            {% endfor %}
          </select><br />

          <label>Address:</label><br />
          <input type="text" name="address" required list="addresses" /><br />

          <br />
          <button type="submit">Create Job</button>
        </form>
      </div>
    </div>
  </body>
</html>
