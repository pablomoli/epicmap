<!doctype html>
<html>
  <head>
    <title>Admin - Jobs</title>
    <link rel="stylesheet" href="/static/css/style.css" />
    <script>
      function toggleFieldwork(jobNumber) {
        const row = document.getElementById("fw-" + jobNumber);
        row.style.display = row.style.display === "none" ? "table-row" : "none";
      }
    </script>
    <style>
      .modal {
        display: none;
        position: fixed;
        z-index: 10;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0, 0, 0, 0.4);
      }

      .modal-content {
        background-color: #fff;
        margin: 10% auto;
        padding: 2em;
        border: 1px solid #ccc;
        width: 400px;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.25);
        font-family: sans-serif;
      }
      .modal-content button {
        background-color: #0066cc;
        color: white;
        padding: 8px 12px;
        border: none;
        border-radius: 4px;
        margin-top: 1em;
        cursor: pointer;
      }
      .modal-content button:hover {
        background-color: #004a99;
      }

      .close {
        color: #555;
        float: right;
        font-size: 24px;
        font-weight: bold;
        margin-top: -10px;
      }
      .close:hover {
        color: #000;
      }
      .modal {
        transition: opacity 0.3s ease;
      }

      .modal-content {
        opacity: 0;
        transform: scale(0.9);
        transition:
          opacity 0.3s ease,
          transform 0.3s ease;
      }
      .modal.show .modal-content {
        opacity: 1;
        transform: scale(1);
      }
    </style>

    <script>
      function openModal(id) {
        const modal = document.getElementById(id);
        modal.style.display = "block";
        setTimeout(() => modal.classList.add("show"), 10);
      }

      function closeModal(id) {
        const modal = document.getElementById(id);
        modal.classList.remove("show");
        setTimeout(() => (modal.style.display = "none"), 300);
      }

      window.onclick = function (event) {
        const modals = document.querySelectorAll(".modal");
        modals.forEach((m) => {
          if (event.target === m) {
            m.style.display = "none";
          }
        });
      };
    </script>
  </head>
  <body>
    <h1>Job Admin Panel</h1>
    {% with messages = get_flashed_messages() %} {% if messages %}
    <ul style="color: green; font-weight: bold">
      {% for msg in messages %}
      <li>{{ msg }}</li>
      {% endfor %}
    </ul>
    {% endif %} {% endwith %}

    <form method="get">
      <label>Job #:</label>
      <input
        type="text"
        name="job_number"
        value="{{ request.args.get('job_number', '') }}"
      />

      <label>Client:</label>
      <input
        type="text"
        name="client"
        value="{{ request.args.get('client', '') }}"
      />

      <label>Status:</label>
      <input
        type="text"
        name="status"
        value="{{ request.args.get('status', '') }}"
      />

      <label>Address:</label>
      <input
        type="text"
        name="address"
        value="{{ request.args.get('address', '') }}"
      />

      <button type="submit">Apply Filters</button>
      <a href="/admin/jobs"><button type="button">Reset</button></a>
    </form>

    <table border="1" style="width: 100%; margin-top: 1em">
      <thead>
        <tr>
          <th>Job #</th>
          <th>Client</th>
          <th>Status</th>
          <th>Address</th>
          <th>Lat</th>
          <th>Long</th>
          <th>County</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for job in jobs %}
        <tr>
          <form method="POST" action="/admin/update_job/{{ job.id }}">
            <td>
              <input name="job_number" value="{{ job.job_number }}" readonly />
            </td>
            <td><input name="client" value="{{ job.client }}" /></td>
            <td><input name="status" value="{{ job.status }}" /></td>
            <td><input name="address" value="{{ job.address }}" /></td>
            <td><input name="lat" value="{{ job.lat }}" /></td>
            <td><input name="long" value="{{ job.long }}" /></td>
            <td><input name="county" value="{{ job.county }}" /></td>
            <td>
              <button type="submit">Update</button>
              <a
                href="/admin/delete_job/{{ job.id }}"
                onclick="return confirm('Are you sure?')"
                >Delete</a
              ><br />
              <button
                type="button"
                onclick="toggleFieldwork('{{ job.job_number }}')"
              >
                Toggle Fieldwork
              </button>
            </td>
          </form>
        </tr>

        <!-- Expandable fieldwork row -->
        <tr id="fw-{{ job.job_number }}" style="display: none">
          <td colspan="8">
            {% set entries = fieldwork.get(job.job_number, []) %} {% if entries
            %}
            <table border="1" width="100%">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Start</th>
                  <th>End</th>
                  <th>Crew</th>
                  <th>Drone Card</th>
                  <th>Total Time</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for fw in entries %}
                <tr>
                  <form
                    method="POST"
                    action="/admin/update_fieldwork/{{ fw.id }}"
                  >
                    <td>
                      <input
                        type="date"
                        name="work_date"
                        value="{{ fw.work_date }}"
                      />
                    </td>
                    <td>
                      <input
                        type="time"
                        name="start_time"
                        value="{{ fw.start_time.strftime('%H:%M') }}"
                      />
                    </td>
                    <td>
                      <input
                        type="time"
                        name="end_time"
                        value="{{ fw.end_time.strftime('%H:%M') }}"
                      />
                    </td>
                    <td><input name="crew" value="{{ fw.crew or '' }}" /></td>
                    <td>
                      <input
                        name="drone_card"
                        value="{{ fw.drone_card or '' }}"
                      />
                    </td>
                    <td>{{ fw.total_time }}</td>
                    <td>
                      <button type="submit">Update</button>
                      <a
                        href="/admin/delete_fieldwork/{{ fw.id }}"
                        onclick="return confirm('Delete this entry?')"
                        >Delete</a
                      >
                    </td>
                  </form>
                </tr>
                {% endfor %}

                <!-- Create new fieldwork entry row -->
                <tr>
                  <td colspan="8">
                    <button
                      onclick="openModal('fw-modal-{{ job.job_number }}')"
                    >
                      + Add Fieldwork
                    </button>

                    <!-- Modal for this job -->
                    <div id="fw-modal-{{ job.job_number }}" class="modal">
                      <div class="modal-content">
                        <span
                          class="close"
                          onclick="closeModal('fw-modal-{{ job.job_number }}')"
                          >&times;</span
                        >
                        <h3>Add Fieldwork for Job {{ job.job_number }}</h3>
                        <form
                          method="POST"
                          action="/admin/create_fieldwork/{{ job.job_number }}"
                        >
                          <label>Date:</label><br />
                          <input type="date" name="work_date" required /><br />

                          <label>Start Time:</label><br />
                          <input type="time" name="start_time" required /><br />

                          <label>End Time:</label><br />
                          <input type="time" name="end_time" required /><br />

                          <label>Crew:</label><br />
                          <input type="text" name="crew" /><br />

                          <label>Drone Card:</label><br />
                          <input type="text" name="drone_card" /><br /><br />

                          <button type="submit">Add Fieldwork</button>
                        </form>
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
            {% else %}
            <p>No fieldwork entries.</p>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>

    <!-- Modal Trigger Button -->
    <button onclick="openModal('createJobModal')">+ Create New Job</button>

    <datalist id="clients">
      {% for job in jobs|unique(attribute='client') if job.client %}
      <option value="{{ job.client }}">{% endfor %}</option>
    </datalist>

    <datalist id="addresses">
      {% for job in jobs|unique(attribute='address') if job.address %}
      <option value="{{ job.address }}">{% endfor %}</option>
    </datalist>

    <!-- Modal -->
    <div id="createJobModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal('createJobModal')"
          >&times;</span
        >
        <h2>Create New Job</h2>
        <form method="POST" action="/admin/create_job">
          <label>Job #:</label><br />
          <input type="text" name="job_number" required /><br />

          <label>Client:</label><br />
          <input type="text" name="client" list="clients" /><br />

          <label>Status:</label><br />
          <input type="text" name="status" /><br />

          <label>Address:</label><br />
          <input type="text" name="address" required list="addresses" /><br />

          <br />
          <button type="submit">Create Job</button>
        </form>
      </div>
    </div>
  </body>
</html>
